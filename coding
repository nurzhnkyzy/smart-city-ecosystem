<!-- ===================================================== -->
<!-- SMARTCITY ‚Äî FULL FINAL HACKATHON VERSION -->
<!-- Unified Urban Management Platform -->
<!-- Roles: Resident | Worker | Admin (Akimat) -->
<!-- Features: eGov Logic, SLA, AI Analysis (Concept), Budget Control -->
<!-- Save as index.html and open in browser -->
<!-- ===================================================== -->

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartCity</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; margin: 0; background:#eef2f7; }
header { background:#0f172a; color:white; padding:15px; display:flex; justify-content:space-between; }
.logo { font-size:22px; font-weight:bold; }
button { padding:8px 12px; margin:5px; cursor:pointer; border:none; border-radius:6px; background:#2563eb; color:white; }
.container { padding:20px; }
.card { background:white; padding:15px; margin-bottom:12px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.08);} 
#map { height:420px; border-radius:10px; }
input, select, textarea { width:100%; padding:8px; margin-top:5px; margin-bottom:10px; }
.hero { background:linear-gradient(135deg,#2563eb,#0ea5e9); color:white; padding:25px; border-radius:12px; margin-bottom:15px; }
.done { color:green; }
.progress { color:orange; }
.new { color:red; }
.overdue { color:red; font-weight:bold; }
.badge { background:#2563eb; color:white; padding:4px 8px; border-radius:8px; }
</style>
</head>

<body>
<header>
<div class="logo">üèô SmartCity</div>
</header>

<div class="container" id="app"></div>

<script>

// ===============================
// DATABASE (LocalStorage MVP)
// ===============================
let requests = JSON.parse(localStorage.getItem("requests") || "[]");
let workerSalary = Number(localStorage.getItem("salary") || 0);

function saveData(){
  localStorage.setItem("requests", JSON.stringify(requests));
  localStorage.setItem("salary", workerSalary);
}

const SLA_HOURS = 48;

function isOverdue(r){
  const now = Date.now();
  const diff = (now - r.createdAt) / (1000*60*60);
  return diff > SLA_HOURS && r.status !== "–í—ã–ø–æ–ª–Ω–µ–Ω–æ";
}

// ===============================
// START SCREEN (ROLE SELECTION)
// ===============================
function renderStart(){
  document.getElementById("app").innerHTML = `
    <div class="hero">
      <h2>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SmartCity</h2>
      <p>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å</p>
    </div>

    <div class="card">
      <button onclick="loginResident()">–ñ–∏—Ç–µ–ª—å (eGov)</button>
      <button onclick="loginWorker()">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ (eGov)</button>
      <button onclick="renderAdminLogin()">–ê–∫–∏–º–∞—Ç</button>
    </div>
  `;
}

function loginResident(){
  alert("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ eGov —É—Å–ø–µ—à–Ω–∞");
  renderResident();
}

function loginWorker(){
  alert("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ eGov —É—Å–ø–µ—à–Ω–∞");
  renderWorker();
}

// ===============================
// ADMIN LOGIN
// ===============================
function renderAdminLogin(){
  document.getElementById("app").innerHTML = `
    <div class="card">
      <h3>–í—Ö–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
      <input id="login" placeholder="–õ–æ–≥–∏–Ω">
      <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
      <button onclick="adminLogin()">–í–æ–π—Ç–∏</button>
    </div>
  `;
}

function adminLogin(){
  const l = document.getElementById("login").value;
  const p = document.getElementById("password").value;
  if(l === "admin" && p === "1234") renderAdmin();
  else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
}

// ===============================
// RESIDENT MODULE
// ===============================
function renderResident(){
  document.getElementById("app").innerHTML = `
    <div class="hero"><h2>–ñ–∏—Ç–µ–ª—å</h2></div>

    <div class="card">
      <h3>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</h3>
      <select id="category">
        <option>–û—Å–≤–µ—â–µ–Ω–∏–µ</option>
        <option>–ú—É—Å–æ—Ä</option>
        <option>–î–æ—Ä–æ–≥–∞</option>
      </select>
      <input id="street" placeholder="–£–ª–∏—Ü–∞">
      <textarea id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
      <input type="file">
      <button onclick="createRequest()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div class="card">
      ${requests.map(r=><div>${r.category} ‚Äî ${r.street} (${r.status})</div>).join("")}
    </div>
  `;
}

function createRequest(){
  const newRequest = {
    id: Date.now(),
    category: document.getElementById("category").value,
    street: document.getElementById("street").value,
    description: document.getElementById("description").value,
    status: "–ü—Ä–∏–Ω—è—Ç–æ",
    assigned:false,
    createdAt: Date.now(),
    beforePhoto:null,
    afterPhoto:null,
    lat:50.411,
    lng:80.227
  };
  requests.push(newRequest);
  saveData();
  renderResident();
}

// ===============================
// WORKER MODULE
// ===============================
function renderWorker(){
  document.getElementById("app").innerHTML = `
    <div class="hero"><h2>–†–∞–±–æ—á–∏–π –∫–∞–±–∏–Ω–µ—Ç</h2></div>

    <div class="card">
      <input placeholder="–ü–æ–∏—Å–∫ –ø–æ —É–ª–∏—Ü–µ" oninput="searchWork()" id="searchStreet">
      <select id="searchCategory" onchange="searchWork()">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
        <option>–û—Å–≤–µ—â–µ–Ω–∏–µ</option>
        <option>–ú—É—Å–æ—Ä</option>
        <option>–î–æ—Ä–æ–≥–∞</option>
      </select>
    </div>

    <div class="card">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${workerSalary} ‚Ç∏</div>

    <div id="workList"></div>
  `;
  renderWorkList(requests);
}

function renderWorkList(list){
  document.getElementById("workList").innerHTML = list
  .filter(r=>r.assigned)
  .map(r=>`
    <div class="card">
      <b>${r.category}</b><br>
      ${r.street}<br>
      ${r.description}<br>
      <input type="file" onchange="uploadBefore(${r.id}, this)"> –§–æ—Ç–æ –î–û<br>
      <input type="file" onchange="uploadAfter(${r.id}, this)"> –§–æ—Ç–æ –ü–û–°–õ–ï<br>
      <button onclick="finishWork(${r.id})">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>
  `).join("");
}

function searchWork(){
  const street = document.getElementById("searchStreet").value.toLowerCase();
  const cat = document.getElementById("searchCategory").value;

  const filtered = requests.filter(r=>
    r.street.toLowerCase().includes(street) &&
    (cat==="" || r.category===cat)
  );
  renderWorkList(filtered);
}

function uploadBefore(id,input){
  const r = requests.find(x=>x.id===id);
  r.beforePhoto = input.value;
  saveData();
}

function uploadAfter(id,input){
  const r = requests.find(x=>x.id===id);
  r.afterPhoto = input.value;
  saveData();
}

function finishWork(id){
  const r = requests.find(x=>x.id===id);
  r.status="–í—ã–ø–æ–ª–Ω–µ–Ω–æ";
  workerSalary += 5000;
  saveData();
  renderWorker();
}

// ===============================
// ADMIN MODULE
// ===============================
function renderAdmin(){
  document.getElementById("app").innerHTML = `
    <div class="hero"><h2>–ü–∞–Ω–µ–ª—å –ê–∫–∏–º–∞—Ç–∞</h2></div>

    <div class="card">
      <h3>–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫</h3>
      ${requests.map(r=>`
        <div>
          ${r.category} ‚Äî ${r.street}
          <button onclick="assignWork(${r.id})">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
        </div>
      `).join("")}
    </div>

    <div class="card">
      <h3>AI –ê–Ω–∞–ª–∏–∑ (–∫–æ–Ω—Ü–µ–ø—Ç)</h3>
      <p>AI –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞.</p>
    </div>

    <div class="card"><div id="map"></div></div>
  `;
  setTimeout(initMap,100);
}

function assignWork(id){
  const r = requests.find(x=>x.id===id);
  r.assigned=true;
  r.status="–í —Ä–∞–±–æ—Ç–µ";
  saveData();
  renderAdmin();
}

function initMap(){
  const map = L.map('map').setView([50.411,80.227],12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

  requests.forEach(r=>{
    let color='red';
    if(r.status==='–í—ã–ø–æ–ª–Ω–µ–Ω–æ') color='green';
    if(isOverdue(r)) color='orange';

    L.circleMarker([r.lat,r.lng],{color:color,radius:8})
    .addTo(map)
    .bindPopup(${r.category}<br>${r.street}<br>${r.status});
  });
}

renderStart();

</script>
</body>
</html>
